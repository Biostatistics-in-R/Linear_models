---
title: "Linear models 5: Factors and continuous variables"
output: 
  learnr::tutorial:
    progressive: false
    theme: cerulean
    highlight: textmate
    css: css/test.css
    code_folding: hide
runtime: shiny_prerendered
author: Rob Knell
description: >
  Linear models with both factors and continuous variables as explaantory variables: how to fit models, check diagnostics and interpret the output.
---



```{r setup, include=FALSE}
library(learnr)
library(gplots)
library(ggplot2)
knitr::opts_chunk$set(echo = TRUE, comment = NA, message = FALSE, fig.width = 5, fig.height = 5)

pinniped <- read.csv("https://github.com/rjknell/Linear_models/raw/master/data/Pinniped_brains.csv")

pinniped$Mate_type <- as.factor(pinniped$Mate_type)
```

## Exercise 1: pinniped brains and mating systems

You should now be starting to feel familiar with fitting linear models with multiple explanatory variables. Up to this point, however, we've focussed on either multiple factors (tutorial 3) or multiple continuous variables (tutorial 4). The next step, of course, is to fit models with both factors and continuous variables. Let's start with an fairly straightforward example. This comes from a study of brain size and mating type in pinnipeds (seals, sealions and walruses) published in 2012 by John Fitzpatrick and coauthors^1^. As part of a study of how mating system might impact on the evolution of brain and body size, Fitzpatrick *et al.* collected data on brain and body size and mating system for males and females from 33 species of pinniped. The data are available on github as a .csv file at https://github.com/rjknell/Linear_models/raw/master/data/Pinniped_brains.csv. Start by importing the data and saving it as an object called `pinnipeds`, and then checking the import with the `str()` function.

```{r pinniped_import, exercise=TRUE}

```

```{r pinniped_import-hint-1}
# You need to use the read.csv() function
# to import the data.
```

```{r pinniped_import-hint-2}
# Don't forget to put the file path (in this
# case the URL) in quote marks
```

```{r pinniped_import-hint-3}
# This is the solution
pinniped <- read.csv("https://github.com/rjknell/Linear_models/raw/master/data/Pinniped_brains.csv")

str(pinniped)
```

We're interested here in the relationship between body mass and brain mass for males, and how it relates to the intensity of sexual selection each species experiences. The latter is indicated here by a variable called `Mate_type` which has two values. `mono` indicates species where the males are *monogynous*, pairing with a single female at a time, whereas `poly` indicates species with *polygynous* males which defend groups of females against rival males during the breeding season. Polygynous males are expected to experience stronger sexual selection during the breeding season.

![](Cape_fur_seals.jpg)
<img src = https://flic.kr/p/2ho4Ujs>

Two male pinnipeds (Cape Fur Seals *Arctocephalus pusillus*, actually a species of sealion) competing for territory in which to defend a group of females. Photo copyright Rob Knell 1999.

Before going any further we should do some exploratory analysis. In this case a scatterplot of `Male_brain_g` versus `Male_mass_Kg` would be appropriate, and you can colour-code it for `Mate_type` by firstly declaring `Mate_type` to be a factor and then specifying `col = Mate_type` as an argument in your `plot()` function call. Since we're just doing some exploratory analysis we won't worry about a legend --- because `poly` comes after `mono` in the alphabet the `poly` data will be coded red and the `mono` data black. Don't forget to label the axes appropriately.

```{r pinniped_scatterplot1, exercise = TRUE}


```

```{r pinniped_scatterplot1-hint-1}
# Make `Mate_type` into a factor by using the
# as.factor() function:

pinniped$Mate_type <- as.factor(pinniped$Mate_type)
```

```{r pinniped_scatterplot1-hint-2}
#  This is the solution
pinniped$Mate_type <- as.factor(pinniped$Mate_type)

plot(Male_brain_g ~ Male_mass_Kg, 
     col = Mate_type, 
     data = pinniped,
     xlab = "Male mass (Kg)",
     ylab = "Brain mass (g)")
```

<br><br>
What do you conclude from this plot?

```{r pinniped_scatterplot_quiz, echo=FALSE}


question("Based on the scatterplot above, which of the following do you think are correct?",
  answer("The relationship between brain mass and body mass is curved and it will be necessary to use a quadratic term in our model", message  = "Answer 1: It's hard to be sure about the nature of this relationship because of the strong positive skew in both variables. It is possible that any curvature will be removed if an appropriate transformation is used. Although there does seem to be some curvature, therefore, it's not clear that we need to fit a curved model."),
  answer("Both variables show strong negative skew", message = "Answer 2. No, these data are showing positive skew. Negative skew would show as the opposite pattern, with data points clustered towards the higher values."),
  answer("There are a number of data points with extreme values which should be removed as outliers", message = "Answer 3. Without any other good reason (data point known to be problematic for reasons other than its value), outliers should only be cautiously removed if the are clearly anomalous and not within the range of values that might be expected given the distribution of the data. Given the strong positive skew evident here there is no reason to remove these extreme values"),
  answer("Both variables show strong positive skew and a data transformation such as a log transformation will be necessary before further analysis", correct = TRUE),
  answer("The heaviest species are all polygynous so the analysis will be invalid unless we remove these", message = "There's no requirement that the explanatory variable should have the same range for both groups. Nonetheless, we should bear this in mind in the analysis: for each mating type we can only really draw conclusions regarding the range of data that we have represented") 
)
```

<br>
<details><summary>**Click here for more on the exploratory analysis**</summary>
<br>
Both variables are strongly positively skewed and it's going to be necessary to correct this with a transformation before proceeding further. Given the nature of the data and the strong positive skew a log transformation would be appropriate: try to generate a new plot like the previous one but with both variables logged. NB neither variable has any zeros so no need to add a constant.


```{r pinniped_scatterplot2, exercise = TRUE}
plot(Male_brain_g ~ Male_mass_Kg, 
     col = Mate_type, 
     data = pinniped)
```

```{r pinniped_scatterplot2-hint-1}
# Just use the log() function on each variable.
# Alternatively, use the log = "xy" argument 

```

```{r pinniped_scatterplot2-hint-2}
#  This is the solution
#  
plot(log(Male_brain_g) ~ log(Male_mass_Kg), 
     col = Mate_type, 
     data = pinniped,
     xlab = "Log of male mass (Kg)",
     ylab = "Log of brain mass (g)")
```

The log transformation seems to have sorted out the problems associated with the very skewed data. Now to fit a model. We'd like the main effects of both `Male_mass_Kg` and `Mate_type`, plus their interaction. Don't forget to log both of the variables that require transformation, and call your fitted model object `P1`.

Once the model is fitted, check the significance of the interaction term using `drop1()`.

```{r pinniped_model1, exercise = TRUE}


```

```{r pinniped_model1-hint-1}
# To fit both main effects and the interaction
# you can use var1 + var2 + var1:var2 or
# var1 * var2.

# You need to specify data = pinniped as an argument
```

```{r pinniped_model1-hint-2}
# For the drop1() don't forget to specify
# test = "F" as an argument.

# Make sure all arguments are separated by a comma 
# for both functions
```

```{r pinniped_model1-hint-3}
# Here is the solution

P1 <- lm(log(Male_brain_g) ~ log(Male_mass_Kg) * Mate_type,
         data = pinniped)

drop1(P1, test = "F")
```

A model with the interaction present has higher explanatory power than one with just the main effects so we'll keep the present model.

</details>

<br><br><hr>

1. Fitzpatrick, J.L., Almbro, M., Gonzalez-Voyer, A., Hamada, S., Pennington, C., Scanlan, J. & Kolm, N. (2012) Sexual selection uncouples the evolution of brain and body size in pinnipeds. Journal of evolutionary biology, 25, 1321â€“1330.

## Diagnostics for the pinniped model

Before we go any further with trying to interpret the model we need to check the diagnostics for our model. Use the `plot()` function and the `which = 1:2` argument to bring up only the first two diagnostic plots.

```{r pinniped_model, echo = FALSE}
P1 <- lm(log(Male_brain_g) ~ log(Male_mass_Kg) * Mate_type,
         data = pinniped)
```


```{r pinniped-diagnostics, exercise.setup = "pinniped_model", exercise = TRUE}

```

```{r pinniped-diagnostics-hint-1}
# This is the solution
plot(P1, which = 1:2)
```

Take a look at these diagnostics and try to answer these questions.

```{r pinniped-diagnostics-quiz, echo=FALSE}
  question(
    "Which of the following statements is correct?",
    answer("The residuals versus fitted values plot shows evidence of strong heteroskedasticity which needs to be corrrected", message = "Answer 1. Heteroskedascticity means that the variance is varying across the range of fitted values, often leading to a plot with a characteristic wedge shape. This plot has some suggestions of a wedge shape but it's not clear and is unlikely to be causing problems with the model fit."),
    answer("It is not clear but there is some indication of negative skew", message = "Answer 2. There's nothing here to indicate negative skew, which would show as more very negative residuals and a convex curve of points on the qq-plot."),
    answer("The qq-plot shows that there is some positive skew in the residuals", message = "Answer 3. The qq-plot is rather well-behaved with all the residuals plotting close to the line. There's nothing to indicate skew in these data."),
    answer(
      "The qq-plot shows that the relationship between at least onf of the explanatory variables and the response variable is non-linear", message = "Answer 4. The qq-plot can only tell you about the distribution of the residuals, not about whether the shape of the relationship between response and epxlanatory variables is linear."),
      answer("The qq-plot indicates that the residuals are approximately normally distributed", correct = TRUE)
    )
```
<br>
<details><summary>**Click here for more on the diagnostics**</summary>

The diagnostic plots do not iondicate anything particualrly concerning. The qq-plot shows no serious deviation from what would be expected if the residuals were normally distributed. The residuals versus fitted values plot shows some hint of increasing variance with higher fitted values but this is not clear. When sample sizes are relatively small it becomes more difficult to see real patterns on diagnostic plots. Furthermore, when sample sizes are small we quite often see patterns that are more a consequence of the chance distribution of a few large positive or negative residuals than representative of a real issue with the data. Given the uncertainty about whether there really is heteroskedasticity, and the general robustness of the linear model, we will leave it as it is.
</details>

## Interpretation of the pinniped model

This video deals with model summaries when there are both factors and continuous explanatory variables. You might want to skip the first 6 minutes which are focussed on simple linear regression but if you're still at all confused about coefficients and summary tables I'd recommend watching the whole thing for a bit of revision.

![](https://youtu.be/aCOgHUSd-SI)

Now check the `summary()` output for the model P1.

```{r pinniped_summary1, exercise.setup = "pinniped_model", exercise = TRUE}

```

```{r pinniped_summary1-hint-1}
# This is the solution

summary(P1)
```
Since we have a model with one continuous explanatory variable and one factor with two levels, and we have an interaction term in our model, we are fitting a model that consists of two lines with different slopes as well as different intercepts. On the basis of the explanation given in the video, try to work out that the equations for the two lines relating log male mass to log brain mass are. Just as a reminder the two factor levels in `Mate_type` are `mono` and `poly` and `mono` comes first alphabetically.

```{r pinniped-summary-quiz, echo=FALSE}
quiz(caption = "Pinniped model interpretation quiz",
  question(
    "Which of the following is the equation of the line relating log male mass to log brain size for **monogynous** species?",
    answer("log(Brain mass) = 2.0779 + 1.9273 x log(Male mass)", message = "Answer 1. 1.9273 is the difference in intercepts and not  slope"),
    answer("log(Brain mass) = 2.0779 + 0.7544 x log(Male mass)", correct = TRUE),
    answer("log(Brain mass) = 2.0779 + 1.9273 + 0.7544 x log(Male mass)", message  = "Answer 2. 1.9273 is the difference in intercepts between the two mating systems and should be added on for polygynoous species"),
    answer("log(Brain mass) = 2.0779 + 1.9273 + (0.7544 - 0.3767) x log(Male mass)", message = "Answer 4. The coefficients for the monogynous species are the first two in the coefficients table.")
    ),

question(
    "Which of the following is the equation of the line relating log male mass to log brain size for **polygynous** species?",
    answer("log(Brain mass) = 2.0779 + 1.9273 x log(Male mass)", message = "Answer 1. 1.9273 is the difference in intercepts and not  slope"),
    answer("log(Brain mass) = 2.0779 + 0.7544 x log(Male mass)", message= "This is the equation for monogynous species"),
    answer("log(Brain mass) = 2.0779 + 1.9273 + 0.7544 x log(Male mass)", message  = "Answer 2. Partly right - but you need the difference in slopes as well as the difference in intercepts"),
    answer("log(Brain mass) = 2.0779 + 1.9273 + (0.7544 - 0.3767) x log(Male mass)", correct = TRUE)
    ),

question(
  "Which of the following statements is true?",
  answer("Brain mass increases more with body mass in polygynous species", message = "The slope is lower in polygynous species so brain mass increases more slowly"),
  answer("Brain mass decreases with body mass in polygynous species", message = "Brain mass increases with body mass in polygynous species, but it does so less than in monogynous species"),
  answer("On average, for every Kg increase in body mass, the brain increases in mass by 0.7544g in monogynous species", message = "The model was fitted to log transformed data so this is not correct"),
  answer("In polygynous species, on average, for an increase of 1 in the log body mass, log brain mass increases by 0.3777", correct = TRUE)
)
)
```

<br>
<details></summary>**Click here for more on the model interpretation**</summary>